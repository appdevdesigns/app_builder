!function(e){function i(o){if(t[o])return t[o].exports;var n=t[o]={i:o,l:!1,exports:{}};return e[o].call(n.exports,n,n.exports,i),n.l=!0,n.exports}var t={};i.m=e,i.c=t,i.i=function(e){return e},i.d=function(e,t,o){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:o})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,i){return Object.prototype.hasOwnProperty.call(e,i)},i.p="",i(i.s=9)}([function(e,i,t){"use strict";window.OP={},OP.Component={},OP.Models={},OP.Component.extend=function(e,i){OP.Component[e]=function(e){e||(e={uuid:webix.uid(),actions:{},unique:function(e){return e+this.uuid},labels:{}});var t=i(e);if(t.actions)for(var o in t.actions)e.actions[o]=t.actions[o];return t}},OP.Dialog=AD.op.Dialog},function(e,i,t){"use strict";function o(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function e(e,i){for(var t=0;t<i.length;t++){var o=i[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(i,t,o){return t&&e(i.prototype,t),o&&e(i,o),i}}();t(7);var a=[],r=function(){function e(i){o(this,e),this.id=i.id,this.name=i.attr("name"),this.label=i.attr("label"),this.description=i.attr("description"),this.role=i.attr("role")}return n(e,[{key:"assignPermissions",value:function(e){var i=this;return new Promise(function(t,o){AD.comm.service.put({url:"/app_builder/"+i.id+"/role/assign",data:{roles:e}}).fail(o).done(t)})}},{key:"getPermissions",value:function(){var e=this;return new Promise(function(i,t){AD.comm.service.get({url:"/app_builder/"+e.id+"/role"}).fail(t).done(i)})}},{key:"createPermission",value:function(){var e=this;return new Promise(function(i,t){AD.comm.service.post({url:"/app_builder/"+e.id+"/role"}).fail(t).done(i)})}},{key:"deletePermission",value:function(){var e=this;return new Promise(function(i,t){AD.comm.service.delete({url:"/app_builder/"+e.id+"/role"}).fail(t).done(i)})}}],[{key:"allApplications",value:function(){return new Promise(function(i,t){var o=AD.Model.get("opstools.BuildApp.ABApplication");o.findAll().fail(t).then(function(t){var n=[];t.forEach(function(i){i.translate&&i.translate(),i.description||i.attr("description",""),n.push(new e(i))}),a=new o.List(n),i(a)})})}},{key:"isValid",value:function(e,i){var t=[];return"add"==e&&a.filter(function(e){return e.name.trim().toLowerCase()==i.label.trim().replace(/ /g,"_").toLowerCase()}).length>0&&t.push({name:"label",mlKey:"duplicateName",defaultText:"**Name must be Unique."}),t}}]),e}();i.default=r,e.exports=i.default},function(e,i,t){"use strict";t(0),t(3),OP.Component.extend("ab",function(e){function i(e,i){return AD.lang.label.getLabel(e)||i}e.labels.common={import:i("ab.common.import","*Import"),edit:i("ab.common.edit","*Edit"),save:i("ab.common.save","*Save"),delete:i("ab.common.delete","*Delete"),export:i("ab.common.export","*Export"),ok:i("ab.common.ok","*Ok"),cancel:i("ab.common.cancel","*Cancel"),yes:i("ab.common.yes","*Yes"),no:i("ab.common.no","*No"),deleteErrorMessage:i("ab.common.delete.error","*System could not delete <b>{0}</b>."),deleteSuccessMessage:i("ab.common.delete.success","*<b>{0}</b> is deleted.")};var t={appbuilder:e.unique("buld_app_loading_screen")},o=OP.Component.ab_choose(e);return{ui:{id:t.appbuilder,container:"ab-main-container",autoheight:!0,autowidth:!0,rows:[o.ui]},logic:{init:function(){o.logic.init(),$$(t.appbuilder).adjust()}},actions:{transitionWorkspace:function(e){console.error("TODO: transitionWorkspace()")},transitionApplicationChooser:function(){console.error("TODO: transitionApplicationChooser()")}}}})},function(e,i,t){"use strict";t(5),t(4),OP.Component.extend("ab_choose",function(e){var i={choose:e.unique("ab_choose")},t=OP.Component.ab_choose_list(e),o=OP.Component.ab_choose_form(e);return{ui:{view:"multiview",id:i.choose,autoheight:!0,cells:[t.ui,o.ui]},logic:{init:function(){t.logic.init(),o.logic.init()}},actions:{transitionApplicationForm:function(e){o.logic.formReset(),e?o.logic.formPopulate(e):t.logic.reset(),o.logic.show()},transitionApplicationList:function(){$$(i.choose).back()}}}})},function(e,i,t){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function n(e,i){return AD.lang.label.getLabel(e)||i}var a=t(1),r=o(a),l={application:{formHeader:n("ab.application.form.header","*Application Info"),placeholderName:n("ab.application.form.placeholderName","*Application name"),placeholderDescription:n("ab.application.form.placeholderDescription","*Application description"),sectionPermission:n("ab.application.form.sectionPermission","*Permission"),permissionHeader:n("ab.application.form.headerPermission","*Assign one or more roles to set permissions for user to view this app"),createNewRole:n("ab.application.form.createNewRoleButton","*Create a new role to view this app"),invalidName:n("ab.application.invalidName","*This application name is invalid"),duplicateName:n("ab.application.duplicateName","*Name must be unique.")}};OP.Component.extend("ab_choose_form",function(e){l.common=e.labels.common;var i={formComponent:e.unique("ab-app-list-form-view"),form:e.unique("ab-app-list-form"),appFormPermissionList:e.unique("ab-app-form-permission"),appFormCreateRoleButton:e.unique("ab-app-form-create-role"),saveButton:e.unique("ab-app-form-button-save")},t={id:i.formComponent,scroll:!0,rows:[{view:"toolbar",cols:[{view:"label",label:l.application.formHeader,fillspace:!0}]},{view:"form",id:i.form,autoheight:!0,margin:0,elements:[{type:"section",template:'<span class="webix_icon fa-edit" style="max-width:32px;"></span>Information',margin:0},{name:"label",view:"text",label:l.common.formName,required:!0,placeholder:l.application.placeholderName,labelWidth:100,on:{onChange:function(e,i){n.permissionRenameRole(e,i)}}},{name:"description",view:"textarea",label:l.common.formDescription,placeholder:l.application.placeholderDescription,labelWidth:100,height:100},{type:"section",template:'<span class="webix_icon fa-lock" style="max-width:32px;"></span>'+l.application.sectionPermission},{view:"toolbar",cols:[{template:l.application.permissionHeader,type:"header",borderless:!0},{view:"toggle",id:i.appFormCreateRoleButton,type:"iconButton",width:300,align:"right",offIcon:"square-o",onIcon:"check-square-o",label:l.application.createNewRole,on:{onItemClick:function(e,t){if(this.getValue()){var o=$$(i.form).elements.label.getValue();n.permissionAddNew(o)}else n.permissionRemoveNew()}}}]},{name:"permissions",id:i.appFormPermissionList,view:"list",height:130,autowidth:!0,borderless:!0,margin:0,css:"ab-app-form-permission",scroll:"y",template:"#name#",on:{onItemClick:function(e,i,t){if(!this.getItem(e).isApplicationRole)if(this.isSelected(e))this.unselect(e);else{var o=this.getSelectedId();"string"!=typeof o&&isNaN(o)||(o=o?[o]:[]),o.push(e),this.select(o)}}}},{height:5},{margin:5,cols:[{fillspace:!0},{id:i.saveButton,view:"button",label:l.common.save,type:"form",width:100,click:function(){n.buttonSaveDisable(),n.formBusy();var i=e.actions.getSelectedApplication();i?n.formValidate("update")&&n.applicationUpdate(i):n.formValidate("add")&&n.applicationCreate(n.formValues())}},{view:"button",value:l.common.cancel,width:100,click:function(){n.cancel()}}]}]}]},o=["label","description"],n={init:function(){webix.extend($$(i.form),webix.ProgressBar),webix.extend($$(i.appFormPermissionList),webix.ProgressBar)},applicationCreate:function(e){var i={name:e.label,label:e.label,description:e.description};async.waterfall([function(e){r.default.create(i).fail(function(i){e(i)}).then(function(i){i.translate&&i.translate(),self.data.push(i),e(null,i)})},function(e,i){self.savePermissions(e).fail(function(e){i(e)}).then(function(){i()})}],function(e){if(n.formReady(),e)return webix.message({type:"error",text:self.labels.common.createErrorMessage.replace("{0}",i.label)}),AD.error.log("App Builder : Error create application data",{error:e}),void saveButton.enable();$$(self.webixUiids.appListRow).show(),$$(self.webixUiids.appList).hideOverlay&&$$(self.webixUiids.appList).hideOverlay(),webix.message({type:"success",text:self.labels.common.createSuccessMessage.replace("{0}",i.label)}),saveButton.enable()})},applicationUpdate:function(e){async.waterfall([function(e){self.savePermissions(updateApp).fail(function(i){e(i)}).then(function(i){e(null,i)})},function(e,i){updateApp.attr("label",appName),updateApp.attr("description",appDescription),e&&e.id?updateApp.attr("role",e.id):updateApp.attr("role",null),updateApp.save().fail(function(e){i(e)}).then(function(e){var t=self.data.filter(function(i,t,o){return i.id===e.id})[0];e.translate&&e.translate(),t.attr("name",e.name),t.attr("label",e.label),t.attr("description",e.description),i(null,e.id)})}],function(e){if($$(self.webixUiids.appListForm).hideProgress(),e)return webix.message({type:"error",text:self.labels.common.updateErrorMessage.replace("{0}",updateApp.attr("label"))}),AD.error.log("App Builder : Error update application data",{error:e}),saveButton.enable(),!1;$$(self.webixUiids.appListRow).show(),webix.message({type:"success",text:self.labels.common.updateSucessMessage.replace("{0}",updateApp.attr("label"))}),saveButton.enable()})},buttonSaveDisable:function(){$$(i.saveButton).disable()},buttonSaveEnable:function(){$$(i.saveButton).enable()},cancel:function(){n.formReset(),e.actions.transitionApplicationList()},formBusy:function(){$$(i.form).showProgress({type:"icon"})},formPopulate:function(e){var t=$$(i.form);e&&o.forEach(function(i){t.elements[i]&&t.elements[i].setValue(e[i])});var n=$$(i.appFormPermissionList);n.showProgress({type:"icon"}),async.waterfall([function(e){AD.comm.service.get({url:"/app_builder/user/roles"}).fail(function(i){e(i)}).done(function(i){e(null,i)})},function(i,t){e&&e.id?e.getPermissions().then(function(e){t(null,i,e)}).catch(function(e){t(e)}):t(null,i,[])},function(t,o,a){if(e&&e.role&&t.forEach(function(i){i.id==(e.role.id||e.role)&&(i.isApplicationRole=!0)}),t.sort(function(e,i){return e.isApplicationRole===i.isApplicationRole?0:e.isApplicationRole?-1:1}),n.clearAll(),n.parse(t),o&&o.length>0){n.select(o);var r=t.filter(function(e){return e.isApplicationRole}).length>0?1:0;$$(i.appFormCreateRoleButton).setValue(r)}a()}],function(e){e&&webix.message(e.message),n.hideProgress()})},formReady:function(){$$(i.form).hideProgress()},formReset:function(){$$(i.form).clear(),$$(i.form).clearValidation()},formValidate:function(e){var t=$$(i.form);if(!t.validate())return n.buttonSaveEnable(),!1;var o=r.default.isValid(e,t.getValues());if(o.length>0){var a=!1;return o.forEach(function(e){t.markInvalid(e.name,l.application[e.mlKey]||e.defaultText),!a&&t.elements[e.name]&&(t.elements[e.name].focus(),a=!0)}),n.buttonSaveEnable(),!1}return!0},formValues:function(){return $$(i.form).getValues()},permissionAddNew:function(e){$$(i.appFormPermissionList).add({id:"newRole",name:n.permissionName(e),isApplicationRole:!0},0);var t=$$(i.appFormPermissionList).getSelectedId(!0);t.push("newRole"),$$(i.appFormPermissionList).select(t)},permissionName:function(e){return e+" Application Role"},permissionRemoveNew:function(){$$(i.appFormPermissionList).find(function(e){return e.isApplicationRole}).forEach(function(e){$$(i.appFormPermissionList).remove(e.id)})},permissionRenameRole:function(e,t){$$(i.appFormPermissionList).find(function(e){return e.name===n.permissionName(t)}).forEach(function(t){var o=$$(i.appFormPermissionList).getItem(t.id);o.name=n.permissionName(e),$$(i.appFormPermissionList).updateItem(o.id,o)})},permissionSave:function(e){return new Promise(function(t,o){var n=[];appRole,$$(i.appFormCreateRoleButton).getValue()?n.push(function(i){e.createPermission().then(function(e){appRole=e,i()}).catch(i)}):n.push(function(i){e.deletePermission().then(function(){i()}).catch(i)});var a=$$(i.appFormPermissionList).getSelectedItem(!0);a=a.filter(function(e){return"newRole"!==e.id}),n.push(function(t){if($$(i.appFormCreateRoleButton).getValue()&&appRole){var o=a.filter(function(e){return e.id==appRole.id});(!o||o.length<1)&&a.push({id:appRole.id,isApplicationRole:!0})}e.assignPermissions(a).then(function(){t()}).catch(t)}),async.series(n,function(e,i){e?o(e):t()})})},show:function(){$$(i.formComponent).show()}};return{ui:t,logic:n}})},function(e,i,t){"use strict";function o(e){return e&&e.__esModule?e:{default:e}}function n(e,i){return AD.lang.label.getLabel(e)||i}var a=t(1),r=o(a);t(6);var l={application:{title:n("ab.application.application","*Application"),createNew:n("ab.application.createNew","*Add new application"),noApplication:n("ab.application.noApplication","*There is no application data")}};OP.Component.extend("ab_choose_list",function(e){l.common=e.labels.common;var i={component:e.unique("ab_choose_listcomponent"),list:e.unique("ab_choose_list"),toolBar:e.unique("ab_choose_list_toolbar"),buttonCreateNewApplication:e.unique("ab_choose_list_buttonNewApp")},t=OP.Component.ab_choose_list_menu(e),o=webix.ui(t.ui);o.hide();var n={id:i.component,cols:[{width:100},{autoheight:!0,autowidth:!0,rows:[{height:30},{view:"toolbar",id:i.toolBar,cols:[{view:"label",label:l.application.title,fillspace:!0},{id:i.buttonCreateNewApplication,view:"button",value:l.application.createNew,width:200,click:function(){e.actions.transitionApplicationForm()}},{view:"uploader",value:l.common.import,width:200,upload:"/app_builder/appJSON",multiple:!1,autosend:!0,on:{onAfterFileAdd:function(){this.disable(),s.busy()},onFileUpload:function(e,i){s.loadData(),this.enable(),s.ready()},onFileUploadError:function(e,i){var t="Error: "+(i&&i.message);webix.message({type:"error",text:t}),s.loadData(),this.enable(),s.ready()}}}]},{id:i.list,view:"list",minHeight:227,autowidth:!0,css:"ab-app-select-list",template:function(e,i){return s.templateListItem(e,i)},type:{height:100,iconGear:"<span class='webix_icon fa-cog'></span>"},select:!1,onClick:{"ab-app-list-item":function(i,t,o){s.busy(),this.select(t);var n=a.listApplications.filter(function(e){return e.id==t});return n&&n.length>0&&(s.ready(),e.actions.selectApplication(n[0])),!1},"ab-app-list-edit":function(e,i,t){return o.show(t),this.select(i),!1}}}]},{width:100}]},a={},s={init:function(){webix.extend($$(i.list),webix.ProgressBar),webix.extend($$(i.list),webix.OverlayBox),t.logic.init(),this.loadData()},busy:function(){$$(i.list).showProgress&&$$(i.list).showProgress({icon:"cursor"})},ready:function(){$$(i.list).hideProgress&&$$(i.list).hideProgress()},reset:function(){$$(i.list).unselectAll()},loadData:function(){s.busy(),r.default.allApplications().then(function(e){s.ready(),a.listApplications=e,s.refreshList()}).catch(function(e){s.ready(),webix.message({type:"error",text:e}),AD.error.log("App Builder : Error loading application data",{error:e})})},refreshList:function(){var e=AD.op.WebixDataCollection(a.listApplications),t=$$(i.list);t.clearAll(),t.data.unsync(),t.data.sync(e),t.count()?t.hideOverlay():t.showOverlay(l.application.noApplication),t.refresh(),s.ready()},show:function(){$$(i.component).show()},templateListItem:function(e,i){return c.replace("#label#",e.label||"").replace("#description#",e.description||"").replace("{common.iconGear}",i.iconGear)}},c=["<div class='ab-app-list-item'>","<div class='ab-app-list-info'>","<div class='ab-app-list-name'>#label#</div>","<div class='ab-app-list-description'>#description#</div>","</div>","<div class='ab-app-list-edit'>","{common.iconGear}","</div>","</div>"].join("");return{ui:n,logic:s,actions:{getSelectedApplication:function(){return $$(i.list).getSelectedItem()},deleteApplication:function(e){e&&(s.busy(),e.destroy().fail(function(i){s.ready(),webix.message({type:"error",text:l.common.deleteErrorMessage.replace("{0}",e.label)}),AD.error.log("App Builder : Error delete application data",{error:i})}).then(function(i){s.ready(),webix.message({type:"success",text:l.common.deleteSuccessMessage.replace("{0}",e.label)})}),s.reset())}}}})},function(e,i,t){"use strict";function o(e,i){return AD.lang.label.getLabel(e)||i}var n={application:{menu:o("ab.application.menu","*Application Menu"),confirmDeleteTitle:o("ab.application.delete.title","*Delete application"),confirmDeleteMessage:o("ab.application.delete.message","*Do you want to delete <b>{0}</b>?")}};OP.Component.extend("ab_choose_list_menu",function(e){n.common=e.labels.common;var i={menu:e.unique("ab-app-list-menu")},t={view:"popup",id:i.menu,head:n.application.menu,width:100,body:{view:"list",data:[{command:n.common.edit,icon:"fa-pencil-square-o"},{command:n.common.delete,icon:"fa-trash"},{command:n.common.export,icon:"fa-download"}],datatype:"json",template:"<i class='fa #icon#' aria-hidden='true'></i> #command#",autoheight:!0,select:!1,on:{onItemClick:function(t,o,a){var r=e.actions.getSelectedApplication();switch(a.textContent.trim()){case n.common.edit:e.actions.transitionApplicationForm(r);break;case n.common.delete:OP.Dialog.ConfirmDelete({title:n.application.confirmDeleteTitle,text:n.application.confirmDeleteMessage.replace("{0}",r.label),callback:function(i){i&&e.actions.deleteApplication(r)}});break;case n.common.export:window.location.assign("/app_builder/appJSON/"+r.id+"?download=1")}$$(i.menu).hide()}}}};return{ui:t,logic:{init:function(){}}}})},function(e,i,t){"use strict";t(8),AD.Model.extend("opstools.BuildApp.ABApplication",{useSockets:!0},{getObjects:function(e){return e||(e={}),e.application=this.id,AD.Model.get("opstools.BuildApp.ABObject").findAll(e)},getObject:function(e){return AD.Model.get("opstools.BuildApp.ABObject").findOne({application:this.id,id:e})},createObject:function(e){var i=$.Deferred(),t=this;return e.application=this.id,AD.Model.get("opstools.BuildApp.ABObject").create(e).fail(i.reject).then(function(e){e.translate&&e.translate(),t.objects.filter(function(i){return(i.id||i)==e.id}).length>0?t.objects.forEach(function(i,o){(i.id||i)==e.id&&t.objects.attr(o,e)}):t.objects.push(e),i.resolve(e)}),i},getApplicationPages:function(e){var i=this,t=null;if(void 0===e&&(e=this.currPage),this.pages&&this.pages.filter){for(var o=function(e){var t=null;return e&&e.parent&&(t=i.pages.filter(function(i){return i.id==e.parent||i.id==e.parent.id})[0]),t},n=o(e);n;)e=n,n=o(e);if(e)return this.getPages({or:[{id:e.id},{parent:e.id}]});t=new Error("application.getApplicationPages(): no root page found!")}else t=new Error("application.getApplicationPages() called with no pages defined.");var a=AD.sal.Deferred();return a.reject(t),a},getAllApplicationPages:function(){var e=this,i=AD.sal.Deferred();return this.getPages().fail(i.reject).done(function(t){e.pages=t,i.resolve(t)}),i},getPages:function(e){return e||(e={}),e.application=this.id,Object.keys(AD.Model.get("opstools.BuildApp.ABPage").store).forEach(function(i){var t=AD.Model.get("opstools.BuildApp.ABPage").store[i];(e.application==t.application.id||t.application)&&delete AD.Model.get("opstools.BuildApp.ABPage").store[i]}),AD.Model.get("opstools.BuildApp.ABPage").findAll(e)},getPage:function(e){return AD.Model.get("opstools.BuildApp.ABPage").store[e]&&delete AD.Model.get("opstools.BuildApp.ABPage").store[e],AD.Model.get("opstools.BuildApp.ABPage").findOne({application:this.id,id:e})},createPage:function(e){var i=$.Deferred(),t=this;return e.application=t.id,AD.Model.get("opstools.BuildApp.ABPage").create(e).fail(i.reject).then(function(e){e.translate&&e.translate(),t.pages.filter(function(i){return(i.id||i)==e.id}).length>0?t.pages.forEach(function(i,o){(i.id||i)==e.id&&t.pages.attr(o,e)}):t.pages.push(e),i.resolve(e)}),i},getPermissions:function(){return AD.comm.service.get({url:"/app_builder/"+this.id+"/role"})},createPermission:function(){return AD.comm.service.post({url:"/app_builder/"+this.id+"/role"})},deletePermission:function(){return AD.comm.service.delete({url:"/app_builder/"+this.id+"/role"})},assignPermissions:function(e){return AD.comm.service.put({url:"/app_builder/"+this.id+"/role/assign",data:{roles:e}})}})},function(e,i,t){"use strict";AD.Model.Base.extend("opstools.BuildApp.ABApplication",{findAll:"GET /app_builder/abapplication",findOne:"GET /app_builder/abapplication/{id}",create:"POST /app_builder/abapplication",update:"PUT /app_builder/abapplication/{id}",destroy:"DELETE /app_builder/abapplication/{id}",describe:function(){return{name:"string",description:"text",permissions:"PermissionRole"}},multilingualFields:["label","description"],fieldId:"id",fieldLabel:"label"},{})},function(e,i,t){"use strict";t(0),t(2),AD.Control.OpsTool.extend("BuildApp",{init:function(e,i){var t=this;i=AD.defaults({templateDOM:"/opstools/BuildApp/views/BuildApp/BuildApp.ejs",resize_notification:"BuildApp.resize",tool:null},i),t.options=i,t._super(e,i),t.data={},t.webixUiId={loadingScreen:"ab-loading-screen",syncButton:"ab-sync-button"},t.initDOM(function(){t.initWebixUI()})},initDOM:function(e){var i=this;can.view(this.options.templateDOM,{},function(t){i.element.html(t),e()})},initWebixUI:function(){var e=OP.Component.ab(),i=e.ui;i.container="ab-main-container",this.AppBuilder=webix.ui(i),e.logic.init()},resize:function(e){var i=this;e=e.height||e;var t=$(i.element);if(t){var o=t.parent().css("width");o&&(o=parseInt(o.replace("px",""))),t.width(o);var n=e-140,a=parseInt(t.css("min-height").replace("px",""));a<n?(t.height(n),$("#ab-main-container").height(n)):(t.height(a),$("#ab-main-container").height(a)),this.AppBuilder&&this.AppBuilder.adjust()}}})}]);